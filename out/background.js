(function(){function t(n){this.type=n;this.port=null;this.reqAry=[];this.reqAry2=[];this.linkAry=[];this.total=0;this.done=0;this.killed=!1}function i(n){chrome.browserAction.setBadgeText({text:n})}function r(n){chrome.browserAction.setTitle({title:n})}var u=new RegExp('<td class="result_text"[^>]*?>.*?<\/td>'),f=/<span itemprop=\"ratingValue\">(\d.\d)</,e=new RegExp("<body(.|\n)*?<\/body>"),o=/\?score=\d{2,3}/,s=/<a href=\"criticreviews.*>.(\d*.\d*)/,n=[];XMLHttpRequest.prototype.sendWithTimeout=function(n){var t=this;setTimeout(function(){t.readyState<4&&t.abort()},n);t.send()};t.prototype={processMsg:function(n){var t=this,f,e,u;for(t.total=n.length,i("..."),r("Checking rating..."),f=0;f<t.total;f++){for(e=new XMLHttpRequest,t.reqAry[f]=e,u=n[f];u.indexOf(" ")!=-1;)u=u.replace(" ","<space>");for(u=encodeURIComponent(u);u.indexOf("%3Cspace%3E")!=-1;)u=u.replace("%3Cspace%3E","+");t.linkAry[f]=t.type=="imdb"?"http://www.imdb.com/find?q="+u+"&s=tt":"http://www.mrqe.com/search?dir=desc&q="+u+"&section=titles&sort=year";e.open("GET",t.linkAry[f],!0);e.onload=function(){t.port.connected?t.processMsg2.bind(this)(t):t.killed||t.kill()};e.onerror=function(){var n=t.reqAry.indexOf(this);t.port.postMessage({type:t.type,idx:n,data:"Error 1",link:t.linkAry[n]});t.checkDone()};e.onabort=function(){var n=t.reqAry.indexOf(this);t.port.postMessage({type:t.type,idx:n,data:"Timeout 1",link:t.linkAry[n]});t.checkDone()};e.sendWithTimeout(2e4)}},processMsg2:function(n){var i=n.reqAry.indexOf(this),r,h,c,t;n.type=="imdb"?(h=$(document.createElement("table")),h.html(this.responseText.match(u)),r=h.find("a:first").attr("href")):(c=$(document.createElement("body")),c.html(this.responseText.match(e)),r=c.find(".results > ul").find("a:first").attr("href"));r!=undefined?(t=new XMLHttpRequest,n.reqAry2[i]=t,n.linkAry[i]=n.type=="imdb"?"http://www.imdb.com"+r:"http://www.mrqe.com"+r,t.open("GET",n.linkAry[i],!0),t.onload=function(){if(n.port.connected){var r=n.reqAry2.indexOf(this),t,i="N/A";n.type=="imdb"?(t=this.responseText.match(f),t!=null&&(i=t[1]),t=this.responseText.match(s),t!=null&&(i=i+", "+t[1])):(t=this.responseText.match(o),t!=null&&(i=t[0].match(/\d{2,3}/)[0]));n.port.postMessage({type:n.type,idx:r,data:i,link:n.linkAry[r]});n.checkDone()}else n.killed||n.kill()},t.onerror=function(){var t=n.reqAry2.indexOf(this);n.port.postMessage({type:n.type,idx:t,data:"Error 2",link:n.linkAry[t]});n.checkDone()},t.onabort=function(){var t=n.reqAry.indexOf(this);n.port.postMessage({type:n.type,idx:t,data:"Timeout 2",link:n.linkAry[t]});n.checkDone()},t.sendWithTimeout(2e4)):(n.port.postMessage({type:n.type,idx:i,data:"N/A",link:n.linkAry[i]}),n.checkDone())},checkDone:function(){var n=this;n.done++;n.done>=n.total&&n.kill()},kill:function(){var t=this,u,e,f,o;if(o=n.indexOf(t),o>=0&&n.splice(o,1),delete t.port,t.reqAry!=undefined){for(f=t.reqAry,e=f.length,u=0;u<e;u++)f[u]!=null&&(f[u].onabort=null,f[u].abort());delete t.reqAry}if(t.reqAry2!=undefined){for(f=t.reqAry2,e=f.length,u=0;u<e;u++)f[u]!=null&&(f[u].onabort=null,f[u].abort());delete t.reqAry2}delete t.linkAry;delete t.total;delete t.done;n.length==0&&(i(""),r(""));t.killed=!0}};chrome.extension.onConnect.addListener(function(i){i.onMessage.addListener(function(r){var u=new t("imdb");u.port=i;n.push(u);u.processMsg(r);i.prc=u;i.connected=!0});i.onDisconnect.addListener(function(){i.connected=!1;i.prc!=undefined&&i.prc.kill()})})})(window)